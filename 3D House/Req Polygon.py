import re
import requests

import os
import numpy as np
import numpy.ma as ma
import pandas as pd
import descartes
import matplotlib.pyplot as plt
import seaborn as sns
sns.set_style("white")
import geopandas as gpd
import rasterio as rio
from rasterio.mask import mask
from rasterio.plot import show
from shapely.geometry import Polygon

import earthpy as et
import earthpy.plot as ep
import shapely
import plotly.graph_objects as go
from rasterio import Affine as A
from rasterio.warp import calculate_default_transform, reproject, Resampling
"""
address = 'Paal-Dorp 20, 3583 Beringen'
address_regx = re.compile("^([A-z-]+)\s(\d+),\s(\d+)\s([A-z]+)")
result = address_regx.search(address)
street = result.group(1)
nb = result.group(2)
pc = result.group(3)
city = result.group(4)

req = requests.get(f"https://api.basisregisters.dev-vlaanderen.be/v1/adresmatch?gemeentenaam={city}&straatnaam={street}&huisnummer={nb}&postcode={pc}").json()

objectId = req["adresMatches"][0]["adresseerbareObjecten"][0]["objectId"]

req = requests.get(f"https://api.basisregisters.dev-vlaanderen.be/v1/gebouweenheden/{objectId}").json()

objectId = req["gebouw"]["objectId"]

req = requests.get(f"https://api.basisregisters.dev-vlaanderen.be/v1/gebouwen/{objectId}").json()

polygon = [req["geometriePolygoon"]["polygon"]]
print(polygon)

print("Polygon coords : ", polygon[0]['coordinates'][0])

pol = [{'coordinates': [[[206534.2682743296, 192365.31859957054], [206530.00075432658, 192368.42951157317], [206530.8269943297, 192369.56295157224], [206530.41918632388, 192369.8602955714], [206530.48101032525, 192369.94503157213], [206528.22667432576, 192371.58829557523], [206528.15307432413, 192371.48730357364], [206525.51358632743, 192373.41127157584], [206525.5873143226, 192373.5122635737], [206523.34193832427, 192375.14899957553], [206523.27320232242, 192375.0546635762], [206522.8639863208, 192375.35303157568], [206522.32254632562, 192374.61024757475], [206520.88382632285, 192372.63648757339], [206517.7801463157, 192374.89882357419], [206509.276594311, 192367.44179956988], [206509.40965031087, 192367.0547915697], [206510.5666423142, 192365.8169035688], [206510.51800231636, 192365.43866356835], [206514.20517031848, 192362.8288715668], [206515.60933031887, 192363.4139595665], [206521.32811432332, 192359.1675595641], [206521.83781032264, 192359.87706356496], [206524.36389032006, 192357.92442356423], [206526.1016183272, 192358.66336756572], [206527.9004663229, 192357.28672756255], [206529.9454583302, 192359.86618356407], [206534.2682743296, 192365.31859957054]]], 'type': 'Polygon'}]
pol22 = [{'coordinates': [[[206556.84286634624, 192353.51987956092], [206543.3967223391, 192360.54765556753], [206540.0063863322, 192354.3565515615], [206542.11006633192, 192353.20455156267], [206542.57630633563, 192351.727815561], [206545.65553833544, 192341.97523955256], [206558.30577834696, 192345.52717555687], [206559.19896234572, 192345.77799155563], [206558.13899434358, 192352.5139915608], [206558.24894634634, 192352.78496756032], [206556.84286634624, 192353.51987956092]]], 'type': 'Polygon'}]
polkerk = [{'coordinates': [[[206415.76510624588, 192426.83667961136], [206421.09592225403, 192428.3391436115], [206421.16542625427, 192428.0924876146], [206422.22001825273, 192428.39098361135], [206422.15077025443, 192428.63648761436], [206429.80760225654, 192430.7945676148], [206429.94021026045, 192430.32429561391], [206430.6239862591, 192430.51706361398], [206430.76363425702, 192430.19744761288], [206430.93528226018, 192429.88218361512], [206431.1393142566, 192429.5758796148], [206431.37547425926, 192429.2831436135], [206431.64248225838, 192429.00871161371], [206431.93816225976, 192428.75744761154], [206432.25944226235, 192428.53344761208], [206432.6023542583, 192428.3404236138], [206432.9624182582, 192428.18119161204], [206433.33438625932, 192428.05779961124], [206433.71326626092, 192427.97127161175], [206434.09355425835, 192427.92122361436], [206434.47013026476, 192427.90688761324], [206434.8387702629, 192427.92634361237], [206435.19499426335, 192427.9770316109], [206435.5358582586, 192428.05587961152], [206435.86891426146, 192428.1633996144], [206436.20107426494, 192428.3030476123], [206436.52798626572, 192428.47584761307], [206436.844786264, 192428.6819276139], [206437.14673826098, 192428.92051961273], [206437.42885026336, 192429.18995961174], [206437.6866422668, 192429.48755961284], [206437.9160182625, 192429.80960761383], [206438.11352226138, 192430.1521356143], [206438.2768502608, 192430.5101516135], [206438.40433826298, 192430.87840761617], [206438.49547426403, 192431.25178361312], [206438.55089826137, 192431.6251596138], [206438.57176226377, 192431.99367161468], [206438.56024226546, 192432.3532236144], [206438.5052022636, 192432.8165836148], [206439.21995426714, 192433.01895161718], [206438.9716342613, 192433.89575161785], [206441.84741026908, 192434.71200761572], [206441.89400226623, 192434.54803961888], [206445.11397027224, 192435.46003961936], [206445.06699427217, 192435.62592761964], [206447.86801826954, 192436.42106361687], [206446.66737826914, 192441.65907962248], [206447.56926626712, 192441.9806156233], [206448.0703862682, 192442.2340556234], [206448.535922274, 192442.54829562455], [206448.9583222717, 192442.9184716232], [206449.33105827123, 192443.338567622], [206449.64824227244, 192443.80218362436], [206449.9047542736, 192444.30176762491], [206450.0966262743, 192444.8296396248], [206450.22078627348, 192445.37735162303], [206450.27544227242, 192445.93632762507], [206450.2594422698, 192446.497735627], [206450.1732982695, 192447.0527436249], [206450.01829027385, 192447.59251962602], [206449.79685027152, 192448.10874362662], [206449.51243427396, 192448.5929676257], [206449.16965027153, 192449.03789562732], [206448.77361827344, 192449.43623162806], [206448.33099427074, 192449.78183162957], [206447.84843426943, 192450.0691916272], [206447.33361826837, 192450.29383162782], [206446.79473827034, 192450.45229562744], [206446.24037026614, 192450.541767627], [206445.6790902689, 192450.56122362986], [206445.1197302714, 192450.51002362743], [206444.46577826887, 192450.3660236299], [206444.28952226788, 192451.05107962713], [206443.82744226605, 192450.93216762692], [206442.6833782643, 192455.55168763176], [206433.1926902607, 192453.38746362925], [206432.8883062601, 192454.03770362958], [206432.57944226265, 192454.52640762925], [206432.2118262574, 192454.97261563316], [206431.79109025747, 192455.3692876324], [206431.32401826233, 192455.7100236304], [206430.8179062605, 192455.98944763094], [206430.2808182612, 192456.20333563164], [206429.72107426077, 192456.34823163226], [206429.14763426036, 192456.4218316339], [206428.56958625466, 192456.42285563052], [206427.99576225877, 192456.35155963153], [206427.43550625443, 192456.20883963257], [206426.89765025675, 192455.99712763354], [206426.3903862536, 192455.71949563175], [206425.92203425616, 192455.38067963347], [206425.49976225197, 192454.985671632], [206425.1304822564, 192454.54099963233], [206424.81969825178, 192454.05344763026], [206424.57253025472, 192453.53082362935], [206424.3928182572, 192452.98131962866], [206424.2833782509, 192452.41351163015], [206424.24600225687, 192451.8366156295], [206424.31013025343, 192450.78304762766], [206407.80958624184, 192446.34637562558], [206402.29297824204, 192444.86304762587], [206402.35121823847, 192444.6426316239], [206401.79710623622, 192444.49632762372], [206402.110450238, 192443.40615162253], [206402.96971423924, 192443.63309562206], [206404.0051062405, 192439.71130362153], [206403.02296224236, 192439.45197562128], [206403.30379424244, 192438.47495162115], [206404.2599542439, 192438.74592762068], [206404.3875702396, 192438.26259962097], [206402.32497823983, 192437.67802361771], [206402.43249823898, 192437.29875962064], [206400.70795423537, 192436.81005561724], [206402.50200223923, 192430.4809676148], [206404.09496223927, 192430.93255161494], [206404.20197024196, 192430.55495161563], [206406.26776224375, 192431.1405516155], [206406.38577824086, 192430.6935756132], [206405.71749024093, 192430.51719161496], [206406.0349302441, 192429.41267961264], [206406.67902623862, 192429.5826636143], [206407.75729824603, 192425.49818361178], [206407.29227424413, 192425.37543161213], [206407.56197024137, 192424.43706361204], [206407.85342624038, 192424.51399160922], [206407.90296224505, 192424.33799161017], [206408.94078624249, 192424.63175161183], [206408.86731424183, 192424.89248761162], [206412.50289824605, 192425.91712761298], [206412.5752182454, 192425.66061561182], [206413.65579424798, 192425.96653561294], [206413.58385824412, 192426.22189561278], [206415.76510624588, 192426.83667961136]]], 'type': 'Polygon'}]


#print(polygon)

#try and cut out polygon from raster :
path_chm = "/home/becode/Documents/Tile_chm25/tile_chm25__172.tif"
#with rio.open(path_chm) as plot_chm:
    #chm = plot_chm.read(1)
plot_chm = rio.open(path_chm)

#show((plot_chm, 1), cmap='terrain')

crop_chm_img, crop_chm_transform = mask(dataset=plot_chm, shapes=polkerk, crop=True, nodata=0, filled=True, indexes=1)
#NO ZEROS FOR MEAN WITH MASK
z = ma.masked_values(crop_chm_img, 0)
print(z)
print(np.mean(z))
# MASK ZOALS BOVEN WERKT BETER VOOR MEAN
no_zeros1 = np.argwhere(crop_chm_img)
no_zeros2 = np.where(crop_chm_img != 0)
print(no_zeros1)
mean_height1 = np.mean(no_zeros1)
mean_height2 = np.mean(no_zeros2)
print(mean_height1,mean_height2 ) # is eigenlijk te hoog!!!
print(np.max(crop_chm_img))
print(np.min(crop_chm_img))


#show((crop_chm_img, 1), cmap='terrain')
#ep.plot_bands(crop_chm_img, title="CHM", cmap="viridis")
#plt.show()

#poly voor nummer 22
#polygon = Polygon([(206556.84286634624, 192353.51987956092), (206543.3967223391, 192360.54765556753), (206540.0063863322, 192354.3565515615), (206542.11006633192, 192353.20455156267), (206542.57630633563, 192351.727815561), (206545.65553833544, 192341.97523955256), (206558.30577834696, 192345.52717555687), (206559.19896234572, 192345.77799155563), (206558.13899434358, 192352.5139915608), (206558.24894634634, 192352.78496756032), (206556.84286634624, 192353.51987956092)])
#poly voor nummer 20
polygon = Polygon([[206415.76510624588, 192426.83667961136], [206421.09592225403, 192428.3391436115], [206421.16542625427, 192428.0924876146], [206422.22001825273, 192428.39098361135], [206422.15077025443, 192428.63648761436], [206429.80760225654, 192430.7945676148], [206429.94021026045, 192430.32429561391], [206430.6239862591, 192430.51706361398], [206430.76363425702, 192430.19744761288], [206430.93528226018, 192429.88218361512], [206431.1393142566, 192429.5758796148], [206431.37547425926, 192429.2831436135], [206431.64248225838, 192429.00871161371], [206431.93816225976, 192428.75744761154], [206432.25944226235, 192428.53344761208], [206432.6023542583, 192428.3404236138], [206432.9624182582, 192428.18119161204], [206433.33438625932, 192428.05779961124], [206433.71326626092, 192427.97127161175], [206434.09355425835, 192427.92122361436], [206434.47013026476, 192427.90688761324], [206434.8387702629, 192427.92634361237], [206435.19499426335, 192427.9770316109], [206435.5358582586, 192428.05587961152], [206435.86891426146, 192428.1633996144], [206436.20107426494, 192428.3030476123], [206436.52798626572, 192428.47584761307], [206436.844786264, 192428.6819276139], [206437.14673826098, 192428.92051961273], [206437.42885026336, 192429.18995961174], [206437.6866422668, 192429.48755961284], [206437.9160182625, 192429.80960761383], [206438.11352226138, 192430.1521356143], [206438.2768502608, 192430.5101516135], [206438.40433826298, 192430.87840761617], [206438.49547426403, 192431.25178361312], [206438.55089826137, 192431.6251596138], [206438.57176226377, 192431.99367161468], [206438.56024226546, 192432.3532236144], [206438.5052022636, 192432.8165836148], [206439.21995426714, 192433.01895161718], [206438.9716342613, 192433.89575161785], [206441.84741026908, 192434.71200761572], [206441.89400226623, 192434.54803961888], [206445.11397027224, 192435.46003961936], [206445.06699427217, 192435.62592761964], [206447.86801826954, 192436.42106361687], [206446.66737826914, 192441.65907962248], [206447.56926626712, 192441.9806156233], [206448.0703862682, 192442.2340556234], [206448.535922274, 192442.54829562455], [206448.9583222717, 192442.9184716232], [206449.33105827123, 192443.338567622], [206449.64824227244, 192443.80218362436], [206449.9047542736, 192444.30176762491], [206450.0966262743, 192444.8296396248], [206450.22078627348, 192445.37735162303], [206450.27544227242, 192445.93632762507], [206450.2594422698, 192446.497735627], [206450.1732982695, 192447.0527436249], [206450.01829027385, 192447.59251962602], [206449.79685027152, 192448.10874362662], [206449.51243427396, 192448.5929676257], [206449.16965027153, 192449.03789562732], [206448.77361827344, 192449.43623162806], [206448.33099427074, 192449.78183162957], [206447.84843426943, 192450.0691916272], [206447.33361826837, 192450.29383162782], [206446.79473827034, 192450.45229562744], [206446.24037026614, 192450.541767627], [206445.6790902689, 192450.56122362986], [206445.1197302714, 192450.51002362743], [206444.46577826887, 192450.3660236299], [206444.28952226788, 192451.05107962713], [206443.82744226605, 192450.93216762692], [206442.6833782643, 192455.55168763176], [206433.1926902607, 192453.38746362925], [206432.8883062601, 192454.03770362958], [206432.57944226265, 192454.52640762925], [206432.2118262574, 192454.97261563316], [206431.79109025747, 192455.3692876324], [206431.32401826233, 192455.7100236304], [206430.8179062605, 192455.98944763094], [206430.2808182612, 192456.20333563164], [206429.72107426077, 192456.34823163226], [206429.14763426036, 192456.4218316339], [206428.56958625466, 192456.42285563052], [206427.99576225877, 192456.35155963153], [206427.43550625443, 192456.20883963257], [206426.89765025675, 192455.99712763354], [206426.3903862536, 192455.71949563175], [206425.92203425616, 192455.38067963347], [206425.49976225197, 192454.985671632], [206425.1304822564, 192454.54099963233], [206424.81969825178, 192454.05344763026], [206424.57253025472, 192453.53082362935], [206424.3928182572, 192452.98131962866], [206424.2833782509, 192452.41351163015], [206424.24600225687, 192451.8366156295], [206424.31013025343, 192450.78304762766], [206407.80958624184, 192446.34637562558], [206402.29297824204, 192444.86304762587], [206402.35121823847, 192444.6426316239], [206401.79710623622, 192444.49632762372], [206402.110450238, 192443.40615162253], [206402.96971423924, 192443.63309562206], [206404.0051062405, 192439.71130362153], [206403.02296224236, 192439.45197562128], [206403.30379424244, 192438.47495162115], [206404.2599542439, 192438.74592762068], [206404.3875702396, 192438.26259962097], [206402.32497823983, 192437.67802361771], [206402.43249823898, 192437.29875962064], [206400.70795423537, 192436.81005561724], [206402.50200223923, 192430.4809676148], [206404.09496223927, 192430.93255161494], [206404.20197024196, 192430.55495161563], [206406.26776224375, 192431.1405516155], [206406.38577824086, 192430.6935756132], [206405.71749024093, 192430.51719161496], [206406.0349302441, 192429.41267961264], [206406.67902623862, 192429.5826636143], [206407.75729824603, 192425.49818361178], [206407.29227424413, 192425.37543161213], [206407.56197024137, 192424.43706361204], [206407.85342624038, 192424.51399160922], [206407.90296224505, 192424.33799161017], [206408.94078624249, 192424.63175161183], [206408.86731424183, 192424.89248761162], [206412.50289824605, 192425.91712761298], [206412.5752182454, 192425.66061561182], [206413.65579424798, 192425.96653561294], [206413.58385824412, 192426.22189561278], [206415.76510624588, 192426.83667961136]])
# JE KAN POLYGON AANMAKEN DOOR POLYGON VAN REQUEST, lijsten, tussen [ ] te zetten
# polygon = Polygon([[206556.84286634624, 192353.51987956092], [206543.3967223391, 192360.54765556753], [206540.0063863322, 192354.3565515615]])
print("area = ", polygon.area, "circumference : ", polygon.length, "mean height : ",np.mean(z), " max height : ", np.max(crop_chm_img))

fig = go.Figure(data=[
    go.Surface(z=crop_chm_img)

])
#fig.update_layout(legend="area = " + str(polygon.area) + "circumference : " + str(polygon.length) + "mean height : " + str(np.mean(z))+" max height : "+str(np.max(crop_chm_img)))
fig.show()

"""
address = 'nze-Lieve-Vrouwstraat 3, 2220 Heist-op-den-Berg'
req = requests.get(f"http://loc.geopunt.be/geolocation/location?q={address}&c=1")
print(req.text)

